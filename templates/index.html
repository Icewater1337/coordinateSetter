{% extends "bootstrap/base.html" %}

{% block content %}
    <img id="displayed-image" src="" data-original-src="" style="display: none;"> <!-- Initially hidden -->

   <div id="imageControls" style="display:none;">
    <br>
        <button onclick="clearClicks()">Clear</button>
        <button onclick="navigate('previous')">Previous</button>
        <button onclick="navigate('next')">Next</button>
        <a href="{{ url_for('download_log') }}" class="btn btn-primary">Download Log</a>

        <p>Last clicked position: <span id="click-position">N/A</span></p>
</div>
<div id="uploadForm">
   <form onsubmit="event.preventDefault();">
            <label for="file">Choose a folder:</label>
        <input type="file" name="file[]" id="imageInput" multiple onchange="storeImagesLocally()" />

            <input type="submit" value="Upload">
        </form>
</div>


    <script>

let clicks = [];

let imageIndex = 0;
let images = [];

let filenames = []; // Add this at the top with other global variables

function storeImagesLocally() {
    const files = document.getElementById('imageInput').files;
    images = [];
    filenames = [];  // Reset the filenames array
    const reader = new FileReader();
    let readIndex = 0;

    function loadNextFile() {
        if (readIndex < files.length) {
            reader.readAsDataURL(files[readIndex]);
        } else {
            displayFirstImage();
        }
    }

    reader.onloadend = function(event) {
        images.push(event.target.result);
        filenames.push(files[readIndex].name);  // Store the filename
        readIndex++;
        loadNextFile();
    }

    loadNextFile();
}

function displayFirstImage() {
    imageIndex = 0;  // Reset to display the first image
    const img = document.getElementById('displayed-image');
    img.addEventListener('click', recordPosition);

    img.style.display = "block";  // Show the image
    img.src = images[0];
    img.setAttribute('data-original-src', images[0]);
    document.getElementById('imageControls').style.display = "block";
    document.getElementById('uploadForm').style.display = "none";
}



function navigate(direction) {
    if (clicks.length === 2) {
        const imagePath = document.getElementById('displayed-image').getAttribute('data-original-src');
        const imageName = filenames[imageIndex];
        const logData = `${imageName};TopLeft:0.${clicks[0].x}l,0.${clicks[0].y}t;BotRight:0.${clicks[1].x}l,0.${clicks[1].y}t`;

        fetch('/log_clicks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ log: logData }),
        });
    }

    if (direction === 'previous' && imageIndex > 0) {
        imageIndex--;
    } else if (direction === 'next' && imageIndex < images.length - 1) {
        imageIndex++;
    }

    const img = document.getElementById('displayed-image');
    img.src = images[imageIndex];
    img.setAttribute('data-original-src', images[imageIndex]);

    clicks = [];  // Reset the clicks array
    document.getElementById('click-position').textContent = "N/A";
}





function recordPosition(event) {
    if (clicks.length < 2) {
        const x = Math.floor((event.offsetX / event.target.width) * 100);
        const y = Math.floor((event.offsetY / event.target.height) * 100);
        clicks.push({ x: x, y: y });
        document.getElementById('click-position').textContent = `${x}% from left, ${y}% from top`;
        if (clicks.length === 2) {
            drawRectangle();
        }
    }
}

function drawRectangle() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('displayed-image');

    canvas.width = img.width;
    canvas.height = img.height;

    ctx.drawImage(img, 0, 0);
    if (clicks.length === 2) {
        ctx.strokeStyle = 'red';
        ctx.strokeRect(clicks[0].x / 100 * img.width, clicks[0].y / 100 * img.height,
                       (clicks[1].x - clicks[0].x) / 100 * img.width,
                       (clicks[1].y - clicks[0].y) / 100 * img.height);
    }

    img.src = canvas.toDataURL();
}

function clearClicks() {
    clicks = [];
    const img = document.getElementById('displayed-image');
    img.src = img.getAttribute('data-original-src');
    document.getElementById('click-position').textContent = "N/A";
}



    </script>
{% endblock %}
